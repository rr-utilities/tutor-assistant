<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>Tutor Assistant v.1.0</title>
    <link rel="stylesheet" href="styles.css">

    <link rel="icon" href="Favicon/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="Favicon/apple-icon.png">
    <meta name="apple-mobile-web-app-title" content="Tutor Assistant">
</head>

<body>
    <a href="index.html">‚¨Ö Zur√ºck</a>
    <h1 id="studentNameTitle">Sch√ºler</h1>

    <div class="section">
        <h2>Termine</h2>
        <table id="eventTable">
            <thead>
                <tr>
                    <th>Titel</th>
                    <th>Datum</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <form id="addEventForm">
            <input type="text" id="eventTitle" placeholder="Titel" required>
            <input type="date" id="eventDate" required>
            <button class="add-btn" type="submit">Hinzuf√ºgen</button>
        </form>
    </div>

    <div class="section">
        <h2>Zahlungen</h2>
        <table id="paymentTable">
            <thead>
                <tr>
                    <th>Titel</th>
                    <th>Betrag (Fr.)</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <form id="addPaymentForm">
            <input type="text" id="paymentTitle" placeholder="Titel" required>
            <input type="number" id="paymentAmount" placeholder="Betrag" required>
            <select id="paymentConfirmed">
                <option value="false">Nicht best√§tigt</option>
                <option value="true">Best√§tigt</option>
            </select>
            <button class="add-btn" type="submit">Hinzuf√ºgen</button>
        </form>
    </div>
</body>

<script>
    let students = JSON.parse(localStorage.getItem("students")) || [];
    const urlParams = new URLSearchParams(window.location.search);
    const index = parseInt(urlParams.get("index"));
    if (!students[index]) {
        alert("Sch√ºler existiert nicht!");
        window.location.href = "index.html";
    }

    const student = students[index];
    document.getElementById("studentNameTitle").textContent = student.name;

    function renderEvents() {
        const tbody = document.getElementById("eventTable").querySelector("tbody");
        tbody.innerHTML = "";
        student.appointments.forEach((appt, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${appt.title}</td><td>${appt.date}</td>`;
            const td = document.createElement("td");

            const del = document.createElement("button");
            del.textContent = "L√∂schen";
            del.onclick = () => { student.appointments.splice(i,1); saveAndRender(); };
            td.appendChild(del);
            tr.appendChild(td);
            tbody.appendChild(tr);
        });
    }

    function renderEvents() {
    const tbody = document.getElementById("eventTable").querySelector("tbody");
    tbody.innerHTML = "";

    student.appointments.forEach((appt, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${appt.title}</td><td>${appt.date}</td>`;
        const td = document.createElement("td");

        // --- üìÖ In Kalender hinzuf√ºgen ---
        const calBtn = document.createElement("button");
        calBtn.textContent = "üìÖ In Kalender";
        calBtn.onclick = () => addToCalendar(appt.title, appt.date);
        td.appendChild(calBtn);

        // --- üóëÔ∏è L√∂schen ---
        const del = document.createElement("button");
        del.textContent = "L√∂schen";
        del.style.marginLeft = "6px";
        del.onclick = () => {
        student.appointments.splice(i, 1);
        saveAndRender();
        };
        td.appendChild(del);

        tr.appendChild(td);
        tbody.appendChild(tr);
    });
    }

    // --- Funktion zum Erstellen und Herunterladen eines Kalender-Events (.ics) ---
    function addToCalendar(title, date) {
    const formattedDate = date.replace(/-/g, '');
    const event = `BEGIN:VCALENDAR
    VERSION:2.0
    BEGIN:VEVENT
    SUMMARY:${title}
    DTSTART:${formattedDate}T120000Z
    DTEND:${formattedDate}T130000Z
    END:VEVENT
    END:VCALENDAR`;

    const blob = new Blob([event], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `${title}.ics`;
    a.click();

    URL.revokeObjectURL(url);
    }

    function renderPayments() {
        const tbody = document.getElementById("paymentTable").querySelector("tbody");
        tbody.innerHTML = "";
        student.payments.forEach((p,i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${p.description}</td><td>${p.amount}</td><td>${p.confirmed ? "Best√§tigt":"Nicht best√§tigt"}</td>`;
            const td = document.createElement("td");
            const toggle = document.createElement("button");
            toggle.textContent = p.confirmed ? "Nicht best√§tigt" : "Best√§tigen";
            toggle.onclick = () => { p.confirmed = !p.confirmed; saveAndRender(); };
            const del = document.createElement("button");
            del.textContent = "L√∂schen";
            del.onclick = () => { student.payments.splice(i,1); saveAndRender(); };
            td.appendChild(toggle);
            td.appendChild(del);
            tr.appendChild(td);
            tbody.appendChild(tr);
        });
    }

    function saveAndRender() {
        localStorage.setItem("students", JSON.stringify(students));
        renderEvents();
        renderPayments();
    }

    document.getElementById("addEventForm").addEventListener("submit", e=>{
        e.preventDefault();
        const title = document.getElementById("eventTitle").value.trim();
        const date = document.getElementById("eventDate").value;
        if(title && date) {
            student.appointments.push({title,date});
            saveAndRender();
        }
        document.getElementById("eventTitle").value="";
        document.getElementById("eventDate").value="";
    });

    document.getElementById("addPaymentForm").addEventListener("submit", e=>{
        e.preventDefault();
        const description = document.getElementById("paymentTitle").value.trim();
        const amount = parseFloat(document.getElementById("paymentAmount").value);
        const confirmed = document.getElementById("paymentConfirmed").value === "true";
        if(description && !isNaN(amount)) {
            student.payments.push({description,amount,confirmed});
            saveAndRender();
        }
        document.getElementById("paymentTitle").value="";
        document.getElementById("paymentAmount").value="";
        document.getElementById("paymentConfirmed").value="false";
    });

    saveAndRender();
</script>

</html>